<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CDI Scope Dashboard — Extended Charts</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #1f2937;
    }

    .page {
      max-width: 1200px;
      margin: 18px auto;
      padding: 12px;
    }

    .scope-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      padding: 10px;
    }

    .scope-card {
      padding: 18px 20px;
      border-radius: 12px;
      color: white;
      box-shadow: 0 6px 20px rgba(2,6,23,0.08);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 110px;
      transition: transform .12s ease;
    }
    .scope-card:hover { transform: translateY(-4px); }

    .scope-title { font-size: 0.95rem; font-weight: 700; opacity: .95; }
    .scope-value { font-size: 1.6rem; font-weight: 800; margin-top: 8px; }
    .scope-instances { margin-top: 8px; font-size: 0.9rem; opacity: .95; }

    .grid {
      display: grid;
      gap: 18px;
      grid-template-columns: 1fr;
      margin-top: 18px;
    }
    @media(min-width: 980px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }

    .chart-box {
      background: white;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.06);
    }
    .chart-title { font-weight: 700; margin-bottom: 10px; color: #111827; }

    /* small utilities */
    .row { display:flex; gap:12px; align-items:center; }
    .controls { display:flex; gap:8px; align-items:center; margin-left:auto; }
    .muted { color: #6b7280; font-size: .9rem; }

  </style>
</head>
<body>
  <div class="page">
    <div id="scopeCards" class="scope-cards" aria-live="polite"></div>

    <!-- Main charts grid -->
    <div class="grid">
      <div class="chart-box">
        <div class="row">
          <div class="chart-title">Beans per Scope</div>
          <div class="controls muted">Simple counts</div>
        </div>
        <canvas id="beansPerScope" height="220"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">Bean Lifecycle Summary (Created / Current / Destroyed) — Stacked</div>
        <canvas id="beanLifecycle" height="220"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">Scope Distribution (Pie)</div>
        <canvas id="scopePie" height="220"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">Top Beans by maxCount (Horizontal)</div>
        <canvas id="topMax" height="320"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">Last Created Timeline (by minute)</div>
        <canvas id="createdTimeline" height="220"></canvas>
      </div>

      <div class="chart-box">
        <div class="chart-title">Qualifiers Distribution</div>
        <canvas id="qualifierDoughnut" height="220"></canvas>
      </div>
    </div>
  </div>

  <script>
    // gradient/card colors (cycled)
    const gradients = [
      "linear-gradient(135deg,#6a11cb,#2575fc)",
      "linear-gradient(135deg,#00c6ff,#0072ff)",
      "linear-gradient(135deg,#43e97b,#38f9d7)",
      "linear-gradient(135deg,#fa709a,#fee140)",
      "linear-gradient(135deg,#7F00FF,#E100FF)",
      "linear-gradient(135deg,#11998e,#38ef7d)"
    ];

    // fetch beans array and render all charts
    async function renderAll() {
      const base = "resources/dev";
      const detailResp = await fetch(base + "/scoped-beans-detail");
      const detail = await detailResp.json().catch(()=> ({}));

      const resp = await fetch(base + "/scoped-beans");
      const beans = await resp.json();

      renderCards(detail);
      const agg = aggregateByScope(beans);
      renderBeansPerScope(agg);
      renderLifecycleStacked(agg);
      renderScopePie(agg);
      renderTopMax(beans);
      renderCreatedTimeline(beans);
      renderQualifierDoughnut(beans);
    }

    // Cards rendering
    function renderCards(detail) {
      const container = document.getElementById("scopeCards");
      container.innerHTML = "";
      let i = 0;
      for (const [scope, info] of Object.entries(detail)) {
        const card = document.createElement("div");
        card.className = "scope-card";
        card.style.background = gradients[i % gradients.length];
        i++;
        const instances = info.instances === null ? "–" : info.instances;
        card.innerHTML = `
          <div class="scope-title">${scope}</div>
          <div class="scope-value">${info.beanCount}</div>
                        <div class="scope-instances">Instances: ${info.instances === null ? "0" : info.instances === 0 ? "0" : info.instances}</div>
        `;
        container.appendChild(card);
      }
    }

    // Aggregate by scope
    function aggregateByScope(beans) {
      const agg = {};
      beans.forEach(b => {
        const s = b.scope || "Unknown";
        if (!agg[s]) agg[s] = { scope: s, beanCount: 0, created: 0, current: 0, destroyed: 0, maxSum: 0 };
        agg[s].beanCount++;
        agg[s].created += (b.createdCount || 0);
        agg[s].current += (b.currentCount || 0);
        agg[s].destroyed += (b.destroyedCount || 0);
        agg[s].maxSum += (b.maxCount || 0);
      });
      return Object.values(agg).sort((a,b)=> b.beanCount - a.beanCount);
    }

    // Chart 1: Beans per scope
    function renderBeansPerScope(agg) {
      const ctx = document.getElementById("beansPerScope").getContext("2d");
      if (window._beansPerScopeChart) window._beansPerScopeChart.destroy();
      window._beansPerScopeChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: agg.map(x => x.scope),
          datasets: [{
            label: "Bean Count",
            data: agg.map(x => x.beanCount),
            backgroundColor: agg.map((_,i)=> `rgba(37,99,235,${0.9 - i*0.06})`)
          }]
        },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // Chart 2: Lifecycle stacked
    function renderLifecycleStacked(agg) {
      const ctx = document.getElementById("beanLifecycle").getContext("2d");
      if (window._beanLifecycle) window._beanLifecycle.destroy();
      window._beanLifecycle = new Chart(ctx, {
        type: "bar",
        data: {
          labels: agg.map(x=> x.scope),
          datasets: [
            { label:"Created", data: agg.map(x=> x.created), backgroundColor:"rgba(34,197,94,0.85)" },
            { label:"Current", data: agg.map(x=> x.current), backgroundColor:"rgba(59,130,246,0.85)" },
            { label:"Destroyed", data: agg.map(x=> x.destroyed), backgroundColor:"rgba(234,88,12,0.85)" }
          ]
        },
        options: {
          responsive:true,
          plugins:{tooltip:{mode:"index", intersect:false}},
          scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
        }
      });
    }

    // Chart 3: Scope pie
    function renderScopePie(agg) {
      const ctx = document.getElementById("scopePie").getContext("2d");
      if (window._scopePie) window._scopePie.destroy();
      window._scopePie = new Chart(ctx, {
        type: "pie",
        data: {
          labels: agg.map(x=> x.scope),
          datasets: [{ data: agg.map(x=> x.beanCount),
            backgroundColor: agg.map((_,i)=> `hsl(${i*60 % 360} 80% 60%)`) }]
        },
        options: { responsive:true, plugins:{legend:{position:"right"}} }
      });
    }

    // Chart 4: Top beans by maxCount
    function renderTopMax(beans) {
      const topN = 10;
      const clones = beans.slice().filter(b => b.maxCount && b.maxCount > 0);
      clones.sort((a,b)=> (b.maxCount||0) - (a.maxCount||0));
      const top = clones.slice(0, topN);
      const labels = top.map(b => shortenClassName(b.beanClass));
      const data = top.map(b => b.maxCount || 0);

      const ctx = document.getElementById("topMax").getContext("2d");
      if (window._topMax) window._topMax.destroy();
      window._topMax = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "maxCount", data, backgroundColor: data.map((_,i)=> `rgba(99,102,241,${0.95 - i*0.06})`) }]
        },
        options: {
          indexAxis: 'y',
          responsive:true,
          plugins:{legend:{display:false}, tooltip:{callbacks:{title: (items)=> top[items[0].dataIndex].beanClass }}} ,
          scales:{ x:{ beginAtZero:true } }
        }
      });
    }

    function shortenClassName(full) {
      if (!full) return '';
      const s = full.replace(/^class\s+|^interface\s+/, "");
      const parts = s.split(".");
      return parts.length > 2 ? parts.slice(-2).join(".") : s;
    }

    // Chart 5: Created timeline (by minute)
    function renderCreatedTimeline(beans) {
      const counts = {};
      beans.forEach(b => {
        if (!b.lastCreated) return;
        const d = new Date(b.lastCreated);
        if (isNaN(d)) return;
        const minute = d.toISOString().slice(0,16); // YYYY-MM-DDTHH:MM
        counts[minute] = (counts[minute] || 0) + 1;
      });

      // last 60 minutes
      const minutes = [];
      for (let i = 59; i >= 0; i--) {
        const dt = new Date();
        dt.setMinutes(dt.getMinutes() - i);
        minutes.push(dt.toISOString().slice(0,16));
      }
      const data = minutes.map(m => counts[m] || 0);

      const ctx = document.getElementById("createdTimeline").getContext("2d");
      if (window._createdTimeline) window._createdTimeline.destroy();
      window._createdTimeline = new Chart(ctx, {
        type: "line",
        data: {
          labels: minutes,
          datasets: [{ label: "Created events per minute", data, fill:true, tension:0.25, backgroundColor:"rgba(99,102,241,0.12)", borderColor:"rgba(99,102,241,0.9)", pointRadius:2 }]
        },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // Chart 6: Qualifiers distribution
    function renderQualifierDoughnut(beans) {
      const counts = {};
      beans.forEach(b => {
        (b.qualifiers || []).forEach(q => {
          if (q === "@Any" || q === "@Default") return; // ignore these
          counts[q] = (counts[q]||0) + 1;
        });
      });
      const labels = Object.keys(counts);
      const data = Object.values(counts);

      const ctx = document.getElementById("qualifierDoughnut").getContext("2d");
      if (window._qualifierDoughnut) window._qualifierDoughnut.destroy();
      window._qualifierDoughnut = new Chart(ctx, {
        type: "doughnut",
        data: { labels, datasets: [{ data, backgroundColor: labels.map((_,i)=> `hsl(${i*50 % 360} 75% 55%)`) }] },
        options: { responsive:true, plugins:{legend:{position:"right"}} }
      });
    }

    // initial render
    renderAll().catch(err => {
      console.error("Failed to render dashboard", err);
      document.getElementById("scopeCards").innerHTML = "<div style='color:red'>Failed to load dashboard; see console.</div>";
    });

  </script>
</body>
</html>
